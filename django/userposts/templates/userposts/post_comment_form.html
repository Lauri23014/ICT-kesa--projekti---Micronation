{% load static %}
<button onClick="commentFormPost{{ post.id }}()" class="post-comment-button">
	{% if request.user.is_authenticated %}
		<img class="profile-picture" src="/media/{{ request.user.profile.profile_pic }}" alt="Profile Picture">
	{% else %}
		<img class="profile-picture" src="{% static 'users/images/default-avatar.jpg' %}" alt="Default Picture">
	{% endif %}
	<p>Type your reply</p>
</button>

<script>
	function commentFormPost{{ post.id }}() {
		{% if request.user.is_authenticated %}
			// post you are replying to
			const replyingTo = document.createElement("div");
			replyingTo.className = "post-block";
			// profile for post
			const replyingToProfile = document.createElement("div");
			replyingToProfile.className = "profile-mini"
			replyingToProfile.onClick = "window.location.href = '{% url 'profile_page' username=post.user.username %}'";
			replyingTo.appendChild(replyingToProfile);
			{% if post.user.profile.profile_pic %}
				const replyingToPFP = document.createElement("img");
				replyingToPFP.className = "profile-picture";
				replyingToPFP.src = "/media/{{ post.user.profile.profile_pic }}";
				replyingToPFP.alt = "Profile Picture";
			{% else %}
				const replyingToPFP = document.createElement("img");
				replyingToPFP.className = "profile-picture";
				replyingToPFP.src = "{% static 'users/images/default-avatar.jpg' %}";
				replyingToPFP.alt = "Default Picture";
			{% endif %}
			const replyingToName = document.createElement("h3")
			replyingToName.innerText = "{{ post.user.username }}";
			replyingToProfile.appendChild(replyingToPFP);
			replyingToProfile.appendChild(replyingToName);
			// post content
			const replyingToPost = document.createElement("article");
			replyingToPost.className = "post-content";
			replyingToPost.onClick = "window.location.href = '/profile/{{ post.user.username }}/post/{{ post.id }}#selected-post'";
			replyingTo.appendChild(replyingToPost);
			const replyingToPostDiv = document.createElement("div");
			replyingToPostDiv.className = "post-content-div";
			replyingToPost.appendChild(replyingToPostDiv);
			{% if post.title %}
				const replyingToPostTitle = document.createElement("h2");
				replyingToPostTitle.innerText = "{{ post.title }}";
				replyingToPostDiv.appendChild(replyingToPostTitle);
			{% endif %}
			replyingToPostText = document.createElement("p");
			replyingToPostText.innerText = "{{ post.text_content|linebreaksbr }}";
			replyingToPostDiv.appendChild(replyingToPostText);
			{% if post.image_file.url != None %}
				const replyingToPostImg = document.createElement("img");
				replyingToPostImg.className = "post-image";
				replyingToPostImg.src = "{{ post.image_file.url }}";
				replyingToPostDiv.appendChild(replyingToPostImg);
			{% endif %}

			// reply
			// profile for reply
			const reply = document.createElement("div");
			reply.className = "post-block";
			const replyProfile = document.createElement("div");
			replyProfile.className = "profile-mini"
			replyProfile.onClick = "window.location.href = '{% url 'profile_page' username=request.user.username %}'";
			reply.appendChild(replyProfile);
			{% if request.user.profile.profile_pic %}
				const replyPFP = document.createElement("img");
				replyPFP.className = "profile-picture";
				replyPFP.src = "/media/{{ request.user.profile.profile_pic }}";
				replyPFP.alt = "Profile Picture";
			{% else %}
				const replyPFP = document.createElement("img");
				replyPFP.className = "profile-picture";
				replyPFP.src = "{% static 'users/images/default-avatar.jpg' %}";
				replyPFP.alt = "Default Picture";
			{% endif %}
			const replyName = document.createElement("h3")
			replyName.innerText = "{{ request.user.username }}";
			replyProfile.appendChild(replyPFP);
			replyProfile.appendChild(replyName);

			// reply form
			const replyForm = document.createElement("form");
			replyForm.method = "POST";
			replyForm.action = "{% url "comment_post" username=post.user.username id=post.id %}";
			replyForm.id = "comment-form-{{ post.id }}";
			const csrftoken = getCookie('csrftoken');
			const replyFormHiddenInput = document.createElement("input");
			replyFormHiddenInput.type = "hidden";
			replyFormHiddenInput.name = "next";
			replyFormHiddenInput.value = "{{ request.path }}";
			replyForm.appendChild(replyFormHiddenInput);
			const replyFormTextInput = document.createElement("input");
			replyFormTextInput.type = "text";
			replyFormTextInput.name = "comment_text";
			replyFormTextInput.maxlenght = "255";
			replyFormTextInput.placeholder = "Type a reply!";
			replyForm.appendChild(replyFormTextInput);
			const replyFormSubmitButton = document.createElement("button");
			replyFormSubmitButton.type = "submit";
			replyFormSubmitButton.innerHtml = "<p>Reply</p>"
			replyForm.appendChild(replyFormSubmitButton);
			replyForm.onsubmit = function(e) {
				e.preventDefault();
				let form = document.getElementById("comment-form-{{ post.id }}");
				let url = form.action;
				let formdata = new FormData(form);

				let options = {
					method: 'POST',
					headers: {'X-CSRFToken': csrftoken},
					mode: 'same-origin', // Do not send CSRF token to another domain.   
					body: formdata,
				};

				fetch(url, options)
				.then(response => response.json())
				.then((response) => {
					if (response.success) {
						let fakeclick = { target: overlay }
						remover{{ post.id }}(fakeclick)
						window.alert("Success!");
					} else {
						window.alert("No Success :(")
					}
				})
			}
			reply.appendChild(replyForm);

			// overlay and binding box
			const overlay = document.createElement("div");
			overlay.className = "post-comment-form-overlay";
			overlay.id = "post-comment-form-overlay-{{ post.id }}";
			overlay.addEventListener("click", (click) => {remover{{ post.id }}(click)});

			const box = document.createElement("div");
			box.className = "post-segment";

			document.body.appendChild(overlay);
			overlay.appendChild(box);
			box.appendChild(replyingTo);
			box.appendChild(reply);
		{% else %}
		
			window.location.href = "{% url 'login' %}";
		{% endif %}
	}

	// function for removing form from screen
	function remover{{ post.id }}(click) {
		const element = click.target;
		if (element.classList.contains("post-comment-form-overlay")) {
			document.getElementById("post-comment-form-overlay-{{ post.id }}").remove();
		}
	}

	function getCookie(name) {
		let cookieValue = null;
		if (document.cookie && document.cookie !== '') {
			const cookies = document.cookie.split(';');
			for (let i = 0; i < cookies.length; i++) {
				const cookie = cookies[i].trim();
				// Does this cookie string begin with the name we want?
				if (cookie.substring(0, name.length + 1) === (name + '=')) {
					cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					break;
				}
			}
		}
		return cookieValue;
	}
</script>